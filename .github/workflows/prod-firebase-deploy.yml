name: Prod | Deploy to Firebase
'on':
  push:
    branches:
      - main
jobs:
  build:
    name: "Building App"
    environment: production
    runs-on: ubuntu-latest
    steps:
      # checking out repo
      - name: Checkout
        uses: actions/checkout@v3
        
      # creating env file
      - name: .env creation
        run: |
          touch .env.prod
          echo NX_ENVIRONMENT="production" >> .env.prod
          echo NX_FIREBASE_AUTH_DOMAIN='${{secrets.NX_FIREBASE_AUTH_DOMAIN}}' >> .env.prod
          echo NX_FIREBASE_DATABASE_URL='${{ secrets.NX_FIREBASE_DATABASE_URL }}' >> .env.prod.prod
          echo NX_FIREBASE_PROJECT_ID='${{secrets.NX_FIREBASE_PROJECT_ID}}' >> .env.prod
          echo NX_FIREBASE_STORAGE_BUCKET='${{secrets.NX_FIREABASE_STORAGE_BUCKET}}' >> .env.prod
          echo NX_FIREBASE_MESSAGING_SENDER_ID='${{ secrets.NX_FIREBASE_MESSAGING_SENDER_ID }}' >> .env.prod
          echo NX_FIREBASE_APP_ID='${{ secrets.NX_FIREBASE_APP_ID }}' >> .env.prod
          echo NX_FIREBASE_MEASUREMENT_ID='${{ secrets.NX_FIREBASE_MEASUREMENT_ID }}' >> .env.prod
          echo NX_FIREBASE_API_KEY='${{ secrets.NX_FIREBASE_API_KEY }}' >> .env.prod
          cat .env.prod
          
      - name: "ðŸ“š Create firebasesc"
        uses: "finnp/create-file-action@master"
        env:
          FILE_NAME: ".firebasesc"
          FILE_DATA: "${{secrets.FIREBASESC}}"
        
      # installing packages and building the app
      - name: Installing packages and buidling app
        run: yarn install --frozen-lockfile && yarn build:app:prod && yarn build:api:prod
        
      # Pushing to Firebase
      # - name: Pushing to Firebase Hosting
      #  uses: FirebaseExtended/action-hosting-deploy@v0
      #  with:
      #    repoToken: '${{ secrets.GITHUB_TOKEN }}'
      #    firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_COS301_MINIPROJECT }}'
      #    projectId: 'cos301-miniproject'
      #    channelId: live
      #    
      # Deploying to firebase functions
      # - name:  Deploy to Firebase
      #  uses: w9jds/firebase-action@master
      #  with:
      #      args: deploy --only functions
      #  env:
      #      FIREBASE_TOKEN: ''${{ secrets.FIREBASE_SERVICE_ACCOUNT_COS301_MINIPROJECT }}''
      #      PROJECT_ID: 'cos301-miniproject'
      
      - uses: w9jds/setup-firebase@main
        with:
          tools-version: 11.27.0
          firebase_token: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_COS301_MINIPROJECT }}
      # - run: firebase use production
      - run: ls -a
      # - run: firebase use production
      - run: firebase deploy --only hosting --project cos301-miniproject
      - run: firebase deploy --only functions --project cos301-miniproject
